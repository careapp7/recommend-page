<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Recommendation</title>
  <style>
    /* リセット & ベース */
    html { height: 100dvh; overscroll-behavior: none; }
    body {
      margin: 0; padding: 0; height: 100%;
      background: #151026; /* 画像から抽出した正確な背景色 */
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro JP", Roboto, sans-serif;
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent;
      overflow: hidden;
      color: #fff;
    }
  </style>
</head>
<body>

<div id="app-scope">
  <style>
    #app-scope {
      /* ▼ 画像からスポイト抽出したカラーパレット */
      --bg-color: #151026;       /* 背景：極めて濃い紫 */
      --card-bg:  #1F1A36;       /* カード：背景より少しだけ明るい紫 */
      --text-main: #FFFFFF;      /* メイン文字 */
      --text-sub:  #B8B2E6;      /* アイコン下の文字色（藤色） */
      --border:    rgba(184, 178, 230, 0.15); /* 薄い枠線 */
      
      /* 画像中央のバナー（初回限定...）のグラデーション */
      --accent-grad: linear-gradient(90deg, #3BDA5C 0%, #D8E019 100%);
      
      position: relative; width: 100%; height: 100%;
      display: flex; flex-direction: column;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* ヘッダー */
    .header {
      flex-shrink: 0; height: 50px;
      display: flex; align-items: center; justify-content: center;
      background: var(--bg-color);
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    .header-title { font-size: 16px; font-weight: 700; color: var(--text-main); }
    .header-back {
      position: absolute; left: 0; top: 0; bottom: 0; width: 50px;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; color: var(--text-sub); cursor: pointer;
    }

    /* メインエリア */
    .main-view {
      flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
      padding: 24px 20px;
    }

    /* 設問ステップバー（アプリのアイコンカラーに合わせる） */
    .step-indicator {
      display: flex; gap: 4px; margin-bottom: 20px; justify-content: center;
    }
    .step-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--border);
    }
    .step-dot.active { background: #3BDA5C; } /* 緑のアクセント */

    /* 質問文 */
    .q-text {
      text-align: center; font-size: 19px; font-weight: 700; line-height: 1.5;
      margin-bottom: 32px; color: var(--text-main);
    }

    /* 選択肢ボタン（アプリの「お知らせ」等のアイコンの並びを意識） */
    .btn-flat {
      display: block; width: 100%;
      padding: 18px; margin-bottom: 12px;
      background: var(--card-bg); /* 少し明るい紫 */
      border: 1px solid var(--border);
      border-radius: 12px; /* アプリの角丸に合わせる */
      color: var(--text-main);
      font-size: 15px; font-weight: 600; text-align: left;
      transition: background 0.1s;
    }
    .btn-flat:active { background: rgba(255,255,255,0.05); }

    /* 結果カード */
    .res-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 16px; padding: 24px; margin-bottom: 24px;
    }
    .res-title {
      font-size: 20px; font-weight: 700; margin-bottom: 12px;
      color: #3BDA5C; /* アクセントの緑 */
    }
    .res-body { font-size: 14px; line-height: 1.8; color: #ddd; white-space: pre-line; }

    /* おすすめリスト（バナーのデザインを模倣） */
    .rec-item {
      display: flex; align-items: center; gap: 14px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px; padding: 12px; margin-bottom: 12px;
    }
    .rec-img {
      width: 50px; height: 50px; border-radius: 50%;
      background: #2a2540; object-fit: cover; flex-shrink: 0;
    }
    
    /* CTAボタン：画像のバナーと同じグラデーション */
    .btn-cta {
      background: var(--accent-grad);
      color: #151026; /* 背景色と同じ濃い色で文字を抜く */
      font-size: 12px; font-weight: 800;
      padding: 8px 16px; border-radius: 99px;
      text-decoration: none; white-space: nowrap;
    }

    /* フッター */
    .footer {
      flex-shrink: 0; padding: 16px 20px;
      background: #120d21; /* 背景より一段階暗く */
      border-top: 1px solid var(--border);
      display: flex; justify-content: center;
    }
    .btn-reset {
      background: transparent; border: none;
      color: var(--text-sub); font-size: 13px; font-weight: 600;
      padding: 10px 20px;
    }

    /* アニメーション */
    .fade-up { animation: fadeUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
    @keyframes fadeUp { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
    
    .loader {
      position: absolute; inset:0; background: var(--bg-color); z-index: 99;
      display:flex; justify-content:center; align-items:center; transition:opacity 0.3s;
    }
    .spinner {
      width: 20px; height: 20px; border: 2px solid var(--text-sub);
      border-top-color: #3BDA5C; border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to{transform:rotate(360deg);} }
  </style>

  <div class="loader" id="loader"><div class="spinner"></div></div>

  <div class="header">
    <div class="header-back" id="btn-back" style="display:none">‹</div>
    <div class="header-title" id="ui-title">Recommend</div>
  </div>

  <div class="main-view" id="app-view"></div>

  <div class="footer">
    <button class="btn-reset" id="btn-reset">最初から</button>
  </div>

  <script>
    (function(){
      // URLs (変更なし)
      const URLs = {
        q: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=1750400212&single=true&output=csv",
        r: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=0&single=true&output=csv",
        res: "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=257661142",
        set: "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=1350915999"
      };

      let db={q:[],r:{},res:{},ui:{}}, state={step:0,score:{},hist:[]};
      const elView = document.getElementById('app-view');
      const btnBack = document.getElementById('btn-back');

      async function init(){
        await Promise.all([load(URLs.q,parseQ),load(URLs.r,parseRecs),load(URLs.res,parseRes),load(URLs.set,parseSet)]);
        document.getElementById('loader').style.opacity=0;
        setTimeout(()=>document.getElementById('loader').style.display='none',300);
        render();
      }

      function render(){
        btnBack.style.display = state.step>0 ? 'flex' : 'none';
        
        if(state.step < db.q.length){
          const q = db.q[state.step];
          // インジケーター生成
          let dots = '';
          for(let i=0;i<db.q.length;i++) dots += `<div class="step-dot ${i===state.step?'active':''}"></div>`;

          elView.innerHTML = `
            <div class="fade-up">
              <div class="step-indicator">${dots}</div>
              <div class="q-text">${q.text}</div>
              <div>
                ${q.choices.map((c,i) => `
                  <button class="btn-flat" onclick="window.ans(${i})">${c.label}</button>
                `).join('')}
              </div>
            </div>`;
        } else {
          const win = Object.entries(state.score).sort((a,b)=>b[1]-a[1])[0]||['A',0];
          const type = win[0];
          const r = db.res[type]||{};
          const list = db.r[type]||[];

          elView.innerHTML = `
            <div class="fade-up">
              <div class="res-card">
                <div class="res-title">${r.title||"Result"}</div>
                <div class="res-body">${(r.body||"").replace(/\\n/g,"\n")}</div>
              </div>
              <div style="font-size:13px;color:var(--text-sub);margin-bottom:12px;font-weight:bold;">${db.ui.recsHeading||"おすすめ"}</div>
              ${list.map(x=>`
                <div class="rec-item">
                  <img class="rec-img" src="${x.img}" onerror="this.style.opacity=0">
                  <div style="flex:1;min-width:0;">
                    <div style="font-weight:700;font-size:14px;margin-bottom:2px;">${x.name}</div>
                    <div style="font-size:11px;color:var(--text-sub);">${x.text}</div>
                  </div>
                  <a href="${x.url}" class="btn-cta" target="_blank">見る</a>
                </div>
              `).join('')}
            </div>`;
        }
      }

      window.ans = (idx) => {
        const c = db.q[state.step].choices[idx];
        Object.keys(c.score).forEach(k=>state.score[k]=(state.score[k]||0)+c.score[k]);
        state.hist.push(c.score);
        state.step++;
        render();
      };
      
      btnBack.onclick = () => {
        if(state.step>0){
          state.step--;
          const prev = state.hist.pop();
          Object.keys(prev).forEach(k=>state.score[k]-=prev[k]);
          render();
        }
      };
      document.getElementById('btn-reset').onclick = ()=>{ state={step:0,score:{},hist:[]}; render(); };

      /* Common Loaders */
      async function load(u,cb){ try{const t=await(await fetch(u+"&t="+Date.now())).text();cb(parse(t));}catch(e){} }
      function parse(t){
        const rows=[],r=[];let c="",q=false;
        for(let i=0;i<t.length;i++){
          let ch=t[i],n=t[i+1];
          if(ch=='"'){q?(n=='"'?(c+='"',i++):(q=!q)):(q=!q);}
          else if(ch==','&&!q){r.push(c);c="";}
          else if((ch=='\n'||ch=='\r')&&!q){if(ch=='\r'&&n=='\n')i++;r.push(c);rows.push([...r]);r.length=0;c="";}
          else c+=ch;
        } if(c)r.push(c); if(r.length)rows.push([...r]);
        const h=rows.shift().map(x=>x.trim());
        return rows.map(rw=>{let o={};h.forEach((k,i)=>o[k]=(rw[i]||"").trim());return o;});
      }
      function parseQ(d){ db.q=d.map(r=>{if(!r.qtext)return null;let cs=[];[1,2,3].forEach(n=>{if(r['choice'+n])cs.push({label:r['choice'+n],score:{[(r['type'+n]||"").toUpperCase()]:Number(r['pts'+n]||0)}})});return cs.length?{text:r.qtext,choices:cs}:null}).filter(Boolean); }
      function parseRecs(d){ d.forEach(r=>{let t=(r.type||"").toUpperCase();if(!db.r[t])db.r[t]=[];db.r[t].push(r);}); }
      function parseRes(d){ d.forEach(r=>db.res[(r.type||"").toUpperCase()]=r); }
      function parseSet(d){ d.forEach(r=>db.ui[r.key]=r.value); if(db.ui.title)document.getElementById('ui-title').innerText=db.ui.title; }

      init();
    })();
  </script>
</div>
</body>
</html>
