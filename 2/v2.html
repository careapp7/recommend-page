<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Immersive App UI</title>
  <style>
    /* â–¼ ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆ */
    html, body {
      height: 100%; margin: 0; padding: 0;
      background: #0f0c29; /* æ·±ã„é—‡å¤œè‰² */
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro JP", "Hiragino Kaku Gothic ProN", Roboto, sans-serif;
      overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ï¼ˆã‚¢ãƒ—ãƒªåŒ–ï¼‰ */
    }
  </style>
</head>
<body>

<div id="app-scope">
  <style>
    #app-scope {
      --primary: #7c4dff;
      --accent: #00e5ff;
      --glass: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
      --text: #ffffff;
      
      position: relative;
      width: 100%; height: 100%;
      color: var(--text);
      display: flex; flex-direction: column;
      isolation: isolate;
    }

    /* --- èƒŒæ™¯ï¼šå‹•ãã‚ªãƒ¼ãƒ–ï¼ˆãƒ¡ãƒƒã‚·ãƒ¥ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é¢¨ï¼‰ --- */
    .orb-bg {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: -1; overflow: hidden;
      background: linear-gradient(to bottom, #1a103c, #000);
    }
    .orb {
      position: absolute; border-radius: 50%;
      filter: blur(60px); opacity: 0.6;
      animation: floatOrb 20s infinite alternate ease-in-out;
    }
    .orb-1 {
      top: -10%; left: -10%; width: 50vw; height: 50vw;
      background: #7c4dff; animation-duration: 25s;
    }
    .orb-2 {
      bottom: -10%; right: -10%; width: 60vw; height: 60vw;
      background: #001f5c; animation-duration: 30s;
    }
    .orb-3 {
      top: 40%; left: 40%; width: 30vw; height: 30vw;
      background: #a855f7; animation-duration: 18s; opacity: 0.4;
    }
    @keyframes floatOrb {
      0% { transform: translate(0, 0) scale(1); }
      100% { transform: translate(30px, 50px) scale(1.1); }
    }

    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
    .header {
      padding: 20px;
      display: flex; justify-content: space-between; align-items: center;
      z-index: 10;
    }
    .status-chip {
      background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
      padding: 6px 12px; border-radius: 20px; font-size: 11px; letter-spacing: 1px;
      backdrop-filter: blur(4px);
    }

    /* --- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼ˆä¸­å¤®é…ç½®ï¼‰ --- */
    .main-view {
      flex: 1;
      display: flex; flex-direction: column; justify-content: center; /* å‚ç›´ä¸­å¤® */
      padding: 24px;
      position: relative;
      perspective: 1000px; /* 3DåŠ¹æœç”¨ */
    }

    /* --- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼ˆä¸Šéƒ¨å›ºå®šï¼‰ --- */
    .progress-container {
      position: absolute; top: 0; left: 24px; right: 24px;
      height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%; background: #00e5ff;
      box-shadow: 0 0 10px #00e5ff; /* ãƒã‚ªãƒ³å…‰ */
      transition: width 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }

    /* --- è³ªå•ã‚«ãƒ¼ãƒ‰ --- */
    .q-card {
      text-align: center;
      margin-bottom: 40px;
    }
    .q-step {
      font-size: 12px; color: #a8a8a8; margin-bottom: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;
      animation: fadeInDown 0.5s ease backwards;
    }
    .q-text {
      font-size: 24px; font-weight: 800; line-height: 1.4;
      text-shadow: 0 4px 20px rgba(0,0,0,0.5);
      animation: fadeInUp 0.6s ease backwards 0.1s; /* é…å»¶ç™»å ´ */
    }

    /* --- é¸æŠè‚¢ãƒœã‚¿ãƒ³ï¼ˆGlassmorphismï¼‰ --- */
    .choices-wrapper {
      display: flex; flex-direction: column; gap: 16px;
      width: 100%; max-width: 400px; margin: 0 auto;
    }
    .glass-btn {
      position: relative;
      width: 100%; padding: 20px;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      color: white; font-size: 16px; font-weight: 600;
      text-align: left;
      cursor: pointer;
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 4px 24px -1px rgba(0,0,0,0.2);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
      
      /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼šæœ€åˆã¯é€æ˜ */
      opacity: 0; transform: translateY(20px);
      animation: fadeInUp 0.5s ease forwards;
    }
    /* ã‚¹ã‚¿ã‚¬ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆé¸æŠè‚¢ãŒé †ç•ªã«å‡ºã¦ãã‚‹ï¼‰ */
    .glass-btn:nth-child(1) { animation-delay: 0.2s; }
    .glass-btn:nth-child(2) { animation-delay: 0.3s; }
    .glass-btn:nth-child(3) { animation-delay: 0.4s; }

    /* ãƒ›ãƒãƒ¼ãƒ»ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ãƒªãƒƒãƒãªå‹•ã */
    .glass-btn:active {
      transform: scale(0.96);
      background: rgba(124, 77, 255, 0.3);
      border-color: #7c4dff;
    }
    .glass-btn::before {
      content: ""; position: absolute; top:0; left:0; width:4px; height:100%;
      background: #00e5ff; opacity: 0; transition: 0.2s;
    }
    .glass-btn:active::before { opacity: 1; }

    /* --- çµæœç”»é¢ --- */
    .result-view {
      height: 100%; overflow-y: auto; padding-top: 20px; padding-bottom: 100px;
      -webkit-overflow-scrolling: touch;
      animation: zoomIn 0.5s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .res-header {
      text-align: center; margin-bottom: 30px;
    }
    .res-crown { font-size: 40px; margin-bottom: 10px; display:block; animation: pop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
    .res-title {
      font-size: 28px; font-weight: 900;
      background: linear-gradient(135deg, #fff 0%, #00e5ff 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      margin-bottom: 16px;
    }
    .res-box {
      background: rgba(0,0,0,0.3); border-radius: 20px; padding: 24px;
      border: 1px solid var(--glass-border);
      margin-bottom: 30px;
      line-height: 1.8; font-size: 15px; color: #e0e0e0;
    }

    /* ãŠã™ã™ã‚ãƒªã‚¹ãƒˆ */
    .rec-item {
      display: flex; align-items: center; gap: 16px;
      background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid var(--glass-border);
      padding: 16px; border-radius: 18px; margin-bottom: 12px;
    }
    .rec-avatar {
      width: 60px; height: 60px; border-radius: 50%; object-fit: cover;
      border: 2px solid rgba(255,255,255,0.2);
    }
    .rec-btn {
      background: linear-gradient(135deg, #7c4dff, #00e5ff);
      border: none; color: #fff; padding: 10px 20px;
      border-radius: 99px; font-weight: bold; font-size: 12px;
      box-shadow: 0 4px 15px rgba(0, 229, 255, 0.3);
      text-decoration: none;
    }

    /* --- ãƒ•ãƒƒã‚¿ãƒ¼ --- */
    .footer {
      position: absolute; bottom: 0; left: 0; width: 100%;
      padding: 20px; background: linear-gradient(to top, #0f0c29 80%, transparent);
      display: flex; gap: 10px; z-index: 20;
    }
    .nav-btn {
      flex: 1; padding: 16px; border-radius: 16px; border: none;
      background: rgba(255,255,255,0.1); color: #aaa; font-weight: 600;
      backdrop-filter: blur(10px);
    }
    .nav-btn:not(:disabled):active { background: rgba(255,255,255,0.2); color: #fff; }

    /* --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© --- */
    @keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    @keyframes fadeInDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
    @keyframes zoomIn { from { opacity:0; transform:scale(0.9); } to { opacity:1; transform:scale(1); } }
    @keyframes pop { 0% { transform:scale(0); } 80% { transform:scale(1.2); } 100% { transform:scale(1); } }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loader {
      display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;
    }
    .loader-circle {
      width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
      border-top-color: #00e5ff; border-radius: 50%;
      animation: spin 1s infinite linear; margin-bottom: 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <div class="orb-bg">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <div class="header">
    <div style="font-weight:900; font-size:18px; letter-spacing:1px;">DIAGNOSIS</div>
    <div class="status-chip" id="ui-chip">AI BETA</div>
  </div>

  <div id="app-view" style="flex:1; position:relative; overflow:hidden;"></div>

  <div class="footer">
    <button class="nav-btn" id="btn-back" disabled>BACK</button>
    <button class="nav-btn" id="btn-reset">RESET</button>
  </div>

  <script>
    (function(){
      // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
      const URLs = {
        q: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=1750400212&single=true&output=csv",
        r: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=0&single=true&output=csv",
        res: "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=257661142",
        set: "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=1350915999"
      };

      let db = { q:[], recs:{}, res:{}, ui:{} };
      let state = { step: 0, score: {}, hist: [] };
      const view = document.getElementById('app-view');
      const backBtn = document.getElementById('btn-back');

      // åˆæœŸåŒ–
      async function init(){
        renderLoader();
        await Promise.all([
          fetchCSV(URLs.q, parseQ),
          fetchCSV(URLs.r, parseRecs),
          fetchCSV(URLs.res, parseRes),
          fetchCSV(URLs.set, parseSet)
        ]);
        render();
      }

      function renderLoader(){
        view.innerHTML = `<div class="loader"><div class="loader-circle"></div><div style="font-size:12px;opacity:0.7;letter-spacing:2px;">LOADING DATA</div></div>`;
      }

      // æç”»ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
      function render(){
        backBtn.disabled = (state.step === 0);
        
        if(!db.q.length) return;

        // è¨­å•ãƒ¢ãƒ¼ãƒ‰
        if(state.step < db.q.length){
          const q = db.q[state.step];
          const pct = Math.round((state.step / db.q.length) * 100);
          
          view.innerHTML = `
            <div class="main-view">
              <div class="progress-container"><div class="progress-bar" style="width:${pct}%"></div></div>
              
              <div class="q-card">
                <div class="q-step">Question ${state.step + 1}</div>
                <div class="q-text">${q.text}</div>
              </div>

              <div class="choices-wrapper">
                ${q.choices.map((c,i) => `
                  <button class="glass-btn" onclick="window.onAns(${i})">
                    ${c.label}
                  </button>
                `).join('')}
              </div>
            </div>
          `;
        } 
        // çµæœãƒ¢ãƒ¼ãƒ‰
        else {
          renderResult();
        }
      }

      function renderResult(){
        // å‹è€…åˆ¤å®š
        const win = Object.entries(state.score).sort((a,b)=>b[1]-a[1])[0] || ['A',0];
        const type = win[0];
        const res = db.res[type] || {};
        const list = db.recs[type] || [];

        view.innerHTML = `
          <div class="result-view">
            <div style="padding: 0 24px;">
              <div class="res-header">
                <span class="res-crown">ğŸ‘‘</span>
                <div style="font-size:12px;color:#00e5ff;letter-spacing:2px;margin-bottom:8px;">YOUR TYPE</div>
                <div class="res-title">${res.title || "Unknown Type"}</div>
              </div>

              <div class="res-box">
                ${(res.body||"").replace(/\\n/g, "<br>")}
              </div>

              <div style="font-weight:800;margin-bottom:16px;font-size:18px;">Recommended</div>
              
              ${list.map(x => `
                <div class="rec-item">
                  <img class="rec-avatar" src="${x.img}" onerror="this.style.background='#333'">
                  <div style="flex:1;min-width:0;">
                    <div style="font-weight:700;margin-bottom:4px;">${x.name}</div>
                    <div style="font-size:11px;opacity:0.6;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${x.text}</div>
                  </div>
                  <a href="${x.url}" target="_blank" class="rec-btn">VIEW</a>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
      window.onAns = (idx) => {
        const q = db.q[state.step];
        const choice = q.choices[idx];
        
        // ã‚¹ã‚³ã‚¢åŠ ç®—
        Object.keys(choice.score).forEach(k => {
          state.score[k] = (state.score[k]||0) + choice.score[k];
        });
        state.hist[state.step] = choice.score;
        state.step++;
        render();
      };

      backBtn.onclick = () => {
        if(state.step > 0){
          state.step--;
          const prevScore = state.hist[state.step];
          Object.keys(prevScore).forEach(k => state.score[k] -= prevScore[k]);
          render();
        }
      };

      document.getElementById('btn-reset').onclick = () => {
        state = { step:0, score:{}, hist:[] };
        render();
      };

      // --- CSV Parser (ç°¡æ˜“ç‰ˆ) ---
      async function fetchCSV(u, cb){
        try{
          const t = await (await fetch(u+"&t="+Date.now())).text();
          const r = parseText(t);
          cb(r);
        }catch(e){console.error(e);}
      }
      function parseText(txt){
        const rows=[]; let r=[],c="",q=false;
        for(let i=0;i<txt.length;i++){
          let char=txt[i], next=txt[i+1];
          if(char=='"'){ q? (next=='"'?(c+='"',i++):(q=!q)) : (q=!q); }
          else if(char==','&&!q){ r.push(c); c=""; }
          else if((char=='\n'||char=='\r')&&!q){ 
            if(char=='\r'&&next=='\n')i++;
            r.push(c); rows.push(r); r=[]; c=""; 
          } else c+=char;
        }
        if(c) r.push(c); if(r.length) rows.push(r);
        const h = rows.shift().map(x=>x.trim());
        return rows.map(row => {
          let o={}; h.forEach((k,i)=>o[k]=(row[i]||"").trim()); return o;
        });
      }

      // ãƒ‡ãƒ¼ã‚¿æ•´å½¢
      function parseQ(d){
        db.q = d.map(r => {
          if(!r.qtext) return null;
          let cs = [];
          [1,2,3].forEach(n=>{
            if(r['choice'+n]){
              let s={}; s[(r['type'+n]||"").toUpperCase()] = Number(r['pts'+n]||0);
              cs.push({label:r['choice'+n], score:s});
            }
          });
          return cs.length ? {text:r.qtext, choices:cs} : null;
        }).filter(Boolean);
      }
      function parseRecs(d){
        d.forEach(r => {
          let t=(r.type||"").toUpperCase();
          if(!db.recs[t]) db.recs[t]=[];
          db.recs[t].push(r);
        });
      }
      function parseRes(d){
        d.forEach(r => db.res[(r.type||"").toUpperCase()] = r);
      }
      function parseSet(d){
        d.forEach(r => db.ui[r.key] = r.value);
        if(db.ui.chip) document.getElementById('ui-chip').innerText = db.ui.chip;
      }

      init();
    })();
  </script>
</div>
</body>
</html>
