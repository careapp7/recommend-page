<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Recommend Page</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      /* ã‚¢ãƒ—ãƒªã®ãƒ™ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼ */
      background: #1a103c;
      overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯å†…éƒ¨ã‚³ãƒ³ãƒ†ãƒŠã§è¡Œã† */
    }
  </style>
</head>
<body>

<div id="valentine-scope">
  <style>
    /* --- ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ å®šç¾© --- */
    #valentine-scope {
      --v-bg: #1a103c;
      --v-card-bg: #261b4a;
      --v-text: #ffffff;
      --v-muted: #bca4d6;
      
      /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ï¼ˆã‚¢ãƒ—ãƒªã®ç´«ã€œé’ç´«ï¼‰ */
      --v-accent-start: #7c4dff;
      --v-accent-end: #a855f7;
      
      /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
      --v-gradient: linear-gradient(135deg, var(--v-accent-start), var(--v-accent-end));
      --v-glass: rgba(255, 255, 255, 0.08);
      
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--v-text);
      background: var(--v-bg);
      
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      isolation: isolate;
      opacity: 0; 
      transition: opacity 0.4s ease;
    }

    #valentine-scope * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* --- èƒŒæ™¯æ¼”å‡ºï¼ˆãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼‰ --- */
    #valentine-scope .bg-particles {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
      z-index: -1;
      overflow: hidden;
      opacity: 0.4;
    }
    #valentine-scope .particle {
      position: absolute;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      animation: floatUp linear infinite;
    }
    @keyframes floatUp {
      0% { transform: translateY(100vh) scale(0); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: translateY(-10vh) scale(1); opacity: 0; }
    }

    /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    #valentine-scope .scroll-area {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 20px 20px 100px; /* ä¸‹éƒ¨ã¯ãƒœã‚¿ãƒ³ãƒãƒ¼ã®åˆ†ç©ºã‘ã‚‹ */
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    #valentine-scope .topbar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    #valentine-scope .title {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      margin: 0 0 4px 0;
      letter-spacing: 0.02em;
    }
    #valentine-scope .subtitle {
      font-size: 12px;
      color: var(--v-muted);
      line-height: 1.4;
    }
    #valentine-scope .chip {
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 99px;
      white-space: nowrap;
    }

    /* --- è³ªå•ã‚«ãƒ¼ãƒ‰ & ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
    #valentine-scope .anim-container {
      /* æ¯å›DOMã‚’æ›¸ãæ›ãˆã‚‹ãŸã³ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç™ºç«ã•ã›ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ */
      animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    #valentine-scope .progress-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    #valentine-scope .step-label {
      font-size: 13px;
      font-weight: 700;
      color: var(--v-accent-end);
    }
    #valentine-scope .bar-bg {
      flex: 1;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 99px;
      overflow: hidden;
    }
    #valentine-scope .bar-fill {
      height: 100%;
      background: var(--v-gradient);
      transition: width 0.4s ease;
      border-radius: 99px;
    }

    /* è³ªå•æ–‡ */
    #valentine-scope .q-text {
      font-size: 18px;
      font-weight: 700;
      line-height: 1.6;
      margin-bottom: 32px;
      color: #fff;
    }

    /* é¸æŠè‚¢ãƒœã‚¿ãƒ³ */
    #valentine-scope .choiceBtn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-align: left;
      
      /* ã‚¢ãƒ—ãƒªã®ã€Œæ ç·šãƒœã‚¿ãƒ³ã€ã‚¹ã‚¿ã‚¤ãƒ« */
      background: transparent;
      border: 1px solid rgba(124, 77, 255, 0.5);
      color: #fff;
      
      padding: 18px 20px;
      margin-bottom: 12px;
      border-radius: 99px; /* Pill shape */
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
    }
    /* ãƒœã‚¿ãƒ³ã®ãƒã‚¤ã‚¯ãƒ­ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ */
    #valentine-scope .choiceBtn:active {
      transform: scale(0.96); /* æŠ¼ã—ãŸæ™‚ã«å°‘ã—ç¸®ã‚€ */
      background: rgba(124, 77, 255, 0.15);
    }
    #valentine-scope .choiceBtn::after {
      content: "â†’";
      opacity: 0;
      transform: translateX(-10px);
      transition: all 0.2s;
      font-weight: bold;
      color: var(--v-accent-end);
    }
    #valentine-scope .choiceBtn:active::after {
      opacity: 1;
      transform: translateX(0);
    }

    /* --- çµæœç”»é¢ (ç‰¹åˆ¥æ„Ÿã®ã‚ã‚‹ãƒ‡ã‚¶ã‚¤ãƒ³) --- */
    #valentine-scope .result-card {
      /* ã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ åŠ¹æœ */
      background: rgba(30, 20, 60, 0.6);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    #valentine-scope .res-title {
      font-size: 22px;
      font-weight: 800;
      margin-bottom: 12px;
      background: linear-gradient(to right, #fff, #dcdcdc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    #valentine-scope .res-body {
      font-size: 15px;
      line-height: 1.8;
      color: rgba(255,255,255,0.95);
      margin-bottom: 20px;
      white-space: pre-line;
    }
    #valentine-scope .res-tip {
      background: rgba(168, 85, 247, 0.15);
      border-left: 4px solid var(--v-accent-end);
      padding: 12px 16px;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.6;
      color: #e9d5ff;
    }

    /* ãŠã™ã™ã‚ãƒªã‚¹ãƒˆ */
    #valentine-scope .rec-heading {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 12px;
      padding-left: 4px;
      border-left: 3px solid var(--v-accent-start);
      padding-left: 10px;
    }
    #valentine-scope .rec-item {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--v-card-bg);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 12px;
      border-radius: 16px;
      margin-bottom: 12px;
    }
    #valentine-scope .rec-avatar {
      width: 56px; height: 56px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
    }
    #valentine-scope .rec-content {
      flex: 1;
      min-width: 0;
    }
    #valentine-scope .rec-name {
      font-weight: 700;
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #valentine-scope .rec-badge {
      display: inline-block;
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 99px;
      background: rgba(255,255,255,0.1);
      color: #bca4d6;
      margin: 4px 0;
      border: 1px solid rgba(255,255,255,0.1);
    }
    #valentine-scope .rec-desc {
      font-size: 11px;
      opacity: 0.7;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    /* CTAãƒœã‚¿ãƒ³ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§å¼·èª¿ï¼‰ */
    #valentine-scope .cta-btn {
      text-decoration: none;
      background: var(--v-gradient);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      padding: 10px 18px;
      border-radius: 99px;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(124, 77, 255, 0.3);
      transition: transform 0.1s;
    }
    #valentine-scope .cta-btn:active {
      transform: scale(0.92);
    }

    /* --- ãƒ•ãƒƒã‚¿ãƒ¼ãƒãƒ¼ --- */
    #valentine-scope .bottom-bar {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: #150c30; /* ã‚¢ãƒ—ãƒªã®ã‚¿ãƒ–ãƒãƒ¼è‰² */
      padding: 16px 20px;
      padding-bottom: max(16px, env(safe-area-inset-bottom)); /* iPhone Xå¯¾ç­– */
      display: flex;
      gap: 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
      z-index: 10;
    }
    #valentine-scope .nav-btn {
      flex: 1;
      border: none;
      background: rgba(255,255,255,0.08);
      color: var(--v-text);
      padding: 14px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    #valentine-scope .nav-btn:disabled {
      opacity: 0.3;
      pointer-events: none;
    }
    #valentine-scope .nav-btn:active {
      background: rgba(255,255,255,0.15);
    }

    /* --- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° --- */
    #valentine-scope .loading-view {
      height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--v-muted);
      font-size: 12px;
    }
    #valentine-scope .spinner {
      width: 32px; height: 32px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--v-accent-end);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>

  <div class="bg-particles" id="particles"></div>

  <div class="scroll-area" id="scroll-target">
    <div class="topbar">
      <div>
        <h1 class="title" id="ui-title">Recommend</h1>
        <div class="subtitle" id="ui-subtitle">Now Loading...</div>
      </div>
      <div class="chip" id="ui-chip" style="display:none"></div>
    </div>

    <div id="val-app"></div>
  </div>

  <div class="bottom-bar">
    <button class="nav-btn" id="val-backBtn" disabled>æˆ»ã‚‹</button>
    <button class="nav-btn" id="val-resetBtn">æœ€åˆã‹ã‚‰</button>
  </div>

  <script>
    (function(){
      // â–¼ è¨­å®šï¼šGoogle Sheets CSV URL
      const URLs = {
        questions: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=1750400212&single=true&output=csv",
        recs:      "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=0&single=true&output=csv",
        results:   "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=257661142",
        settings:  "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=1350915999"
      };

      // â–¼ çŠ¶æ…‹ç®¡ç†
      let data = { questions: [], recs: {}, results: {}, ui: {} };
      let state = { step: 0, score: { A:0, B:0, C:0 }, answers: [] };
      let loadedFlags = { q:false, r:false, res:false, set:false };
      
      // â–¼ DOMè¦ç´ 
      const els = {
        scope: document.getElementById("valentine-scope"),
        app: document.getElementById("val-app"),
        backBtn: document.getElementById("val-backBtn"),
        resetBtn: document.getElementById("val-resetBtn"),
        title: document.getElementById("ui-title"),
        subtitle: document.getElementById("ui-subtitle"),
        chip: document.getElementById("ui-chip"),
        scroll: document.getElementById("scroll-target"),
        particles: document.getElementById("particles")
      };

      // --- åˆæœŸåŒ– & ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° ---
      function init(){
        renderLoading();
        generateParticles();
        
        // ãƒ‡ãƒ¼ã‚¿å–å¾—
        fetchCSV(URLs.questions, parseQuestions, 'q');
        fetchCSV(URLs.recs, parseRecs, 'r');
        fetchCSV(URLs.results, parseResults, 'res');
        fetchCSV(URLs.settings, parseSettings, 'set');
      }

      function generateParticles(){
        let html = '';
        for(let i=0; i<15; i++){
          const left = Math.random() * 100;
          const size = Math.random() * 4 + 2;
          const dur = Math.random() * 10 + 10;
          const delay = Math.random() * 5;
          html += `<div class="particle" style="left:${left}%; width:${size}px; height:${size}px; animation-duration:${dur}s; animation-delay:${delay}s"></div>`;
        }
        els.particles.innerHTML = html;
      }

      function renderLoading(){
        els.app.innerHTML = `
          <div class="loading-view">
            <div class="spinner"></div>
            <div>Contents Loading...</div>
          </div>`;
      }

      // --- CSVå‡¦ç†æ±ç”¨é–¢æ•° ---
      async function fetchCSV(url, parser, flagKey){
        try {
          const res = await fetch(url + "&ts=" + Date.now());
          const text = await res.text();
          parser(parseCSVText(text));
          loadedFlags[flagKey] = true;
          checkAllLoaded();
        } catch(e) {
          console.error("Load Error:", flagKey, e);
        }
      }

      function parseCSVText(text){
        // ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¤å …ç‰¢ãªCSVãƒ‘ãƒ¼ã‚µãƒ¼
        const rows = [];
        let row=[], cell="", inQ=false;
        for(let i=0; i<text.length; i++){
          let c=text[i], n=text[i+1];
          if(c==='"'){
            if(inQ && n==='"'){ cell+='"'; i++; } else { inQ=!inQ; }
          } else if(c===',' && !inQ){
            row.push(cell); cell="";
          } else if((c==='\n'||c==='\r') && !inQ){
            if(c==='\r' && n==='\n') i++;
            row.push(cell);
            if(row.length>1||row[0]!=="") rows.push(row);
            row=[]; cell="";
          } else { cell+=c; }
        }
        row.push(cell);
        if(row.length>1||row[0]!=="") rows.push(row);
        
        const headers = (rows.shift()||[]).map(h=>(h||"").trim());
        return rows.map(r => {
          const obj={};
          headers.forEach((h,i)=>obj[h]=(r[i]??"").trim());
          return obj;
        });
      }

      // --- ãƒ‡ãƒ¼ã‚¿è§£æ ---
      function parseQuestions(rows){
        data.questions = rows.map(r => {
          if(!r.qtext) return null;
          const choices = [];
          [1,2,3].forEach(n => {
            if(r[`choice${n}`]){
              const pts = Number(r[`pts${n}`]||0);
              const type = (r[`type${n}`]||"").toUpperCase();
              choices.push({ label: r[`choice${n}`], score: {[type]: pts} });
            }
          });
          return choices.length ? { text: r.qtext, choices } : null;
        }).filter(Boolean).sort((a,b)=> (a.qid||0)-(b.qid||0));
      }

      function parseRecs(rows){
        const grouped = { A:[], B:[], C:[] };
        rows.forEach(r => {
          const t = (r.type||"").toUpperCase();
          if(grouped[t]) grouped[t].push(r);
        });
        Object.keys(grouped).forEach(k => {
          grouped[k].sort((a,b)=> Number(a.order||99) - Number(b.order||99));
        });
        data.recs = grouped;
      }

      function parseResults(rows){
        rows.forEach(r => {
          const t = (r.type||"").toUpperCase();
          if(t) data.results[t] = { title: r.title, body: r.body, tip: r.tip };
        });
      }

      function parseSettings(rows){
        const def = {
          title: "Recommend", subtitle: "ã‚ãªãŸã«ã´ã£ãŸã‚Šã®é¸æŠã‚’è¨ºæ–­",
          chip: "AI Analysis", recsHeading: "ã‚ãªãŸã¸ã®ãŠã™ã™ã‚",
          noQuestions: "è¨­å•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        };
        rows.forEach(r => { if(r.key) def[r.key] = r.value; });
        data.ui = def;
      }

      function checkAllLoaded(){
        if(loadedFlags.q && loadedFlags.r && loadedFlags.res && loadedFlags.set){
          applyUI();
          els.scope.style.opacity = 1;
          render();
        }
      }

      function applyUI(){
        els.title.textContent = data.ui.title;
        els.subtitle.textContent = (data.ui.subtitle||"").replace(/\\n/g, "\n");
        if(data.ui.chip){
          els.chip.textContent = data.ui.chip;
          els.chip.style.display = "block";
        }
      }

      // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
      function render(){
        els.backBtn.disabled = (state.step === 0);
        els.scroll.scrollTo({top:0, behavior:'smooth'});

        if(!data.questions.length){
          els.app.innerHTML = `<div style="padding:20px;text-align:center">${data.ui.noQuestions}</div>`;
          return;
        }

        // è¨­å•ç”»é¢
        if(state.step < data.questions.length){
          renderQuestion();
        } 
        // çµæœç”»é¢
        else {
          renderResult();
        }
      }

      function renderQuestion(){
        const q = data.questions[state.step];
        const pct = Math.round((state.step / data.questions.length) * 100);
        
        let html = `
          <div class="anim-container">
            <div class="progress-wrap">
              <div class="step-label">Q.${state.step + 1}</div>
              <div class="bar-bg">
                <div class="bar-fill" style="width:${pct}%"></div>
              </div>
            </div>

            <div class="q-text">${q.text}</div>

            <div class="choices-area">
              ${q.choices.map((c, i) => `
                <button class="choiceBtn" onclick="window.handleChoice(${i})">
                  <span>${c.label}</span>
                </button>
              `).join('')}
            </div>
          </div>
        `;
        els.app.innerHTML = html;
      }

      function renderResult(){
        // æœ€é«˜å¾—ç‚¹ã®ã‚¿ã‚¤ãƒ—ã‚’ç®—å‡º
        const win = Object.entries(state.score).sort((a,b)=> b[1]-a[1])[0][0];
        const resData = data.results[win] || {};
        const recList = data.recs[win] || [];

        let html = `
          <div class="anim-container">
            <div class="result-card">
              <div class="res-title">${resData.title || "è¨ºæ–­çµæœ"}</div>
              <div class="res-body">${(resData.body||"").replace(/\\n/g, "<br>")}</div>
              ${resData.tip ? `<div class="res-tip">ğŸ’¡ ${resData.tip.replace(/\\n/g, "<br>")}</div>` : ""}
            </div>

            <div class="rec-heading">${data.ui.recsHeading}</div>
            
            ${recList.map(item => `
              <div class="rec-item">
                <img class="rec-avatar" src="${item.img}" onerror="this.style.display='none'">
                <div class="rec-content">
                  <div class="rec-name">${item.name}</div>
                  ${item.badge ? `<span class="rec-badge">${item.badge}</span>` : ""}
                  <div class="rec-desc">${item.text}</div>
                </div>
                <a href="${item.url}" class="cta-btn" target="_blank">è¦‹ã‚‹</a>
              </div>
            `).join('')}

            <div style="height:40px"></div>
          </div>
        `;
        els.app.innerHTML = html;
      }

      // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ ---
      window.handleChoice = function(idx){
        // ã‚¹ã‚³ã‚¢åŠ ç®—
        const q = data.questions[state.step];
        const choice = q.choices[idx];
        
        Object.keys(choice.score || {}).forEach(k => {
          state.score[k] = (state.score[k]||0) + choice.score[k];
        });

        // å±¥æ­´ä¿å­˜
        state.answers[state.step] = { idx, score: choice.score };
        
        state.step++;
        render();
      };

      els.backBtn.onclick = () => {
        if(state.step > 0){
          state.step--;
          const prev = state.answers[state.step];
          if(prev && prev.score){
            Object.keys(prev.score).forEach(k => {
              state.score[k] -= prev.score[k];
            });
          }
          render();
        }
      };

      els.resetBtn.onclick = () => {
        if(confirm("æœ€åˆã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ")){
          state.step = 0;
          state.score = {A:0, B:0, C:0};
          state.answers = [];
          render();
        }
      };

      // ã‚¹ã‚¿ãƒ¼ãƒˆ
      init();
    })();
  </script>
</div>
</body>
</html>
