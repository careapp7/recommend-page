<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Diagnosis App</title>
  <style>
    /* --- ベースリセット（Web感を消す処理） --- */
    html {
      /* アドレスバー伸縮対策 */
      height: 100dvh; 
      /* スクロール時のバウンス禁止 */
      overscroll-behavior: none; 
    }
    body {
      margin: 0; padding: 0;
      height: 100%;
      background: #0f0c29;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro JP", Roboto, sans-serif;
      /* 文字選択・長押しメニュー禁止 */
      -webkit-user-select: none; user-select: none;
      -webkit-touch-callout: none;
      /* iOSでのタップ時のグレー背景を削除 */
      -webkit-tap-highlight-color: transparent;
      overflow: hidden;
    }
  </style>
</head>
<body>

<div id="app-scope">
  <style>
    #app-scope {
      --primary: #7c4dff;
      --accent: #00e5ff;
      --glass: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.12);
      --text: #ffffff;
      
      /* レイアウト定義 */
      position: relative;
      width: 100%; 
      height: 100%;
      display: flex; 
      flex-direction: column;
      
      /* ▼ iPhoneのノッチ・ホームバー対策 */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      
      isolation: isolate;
      color: white;
    }

    /* --- 背景：軽量なパーティクル（重い処理を回避） --- */
    .bg-gradient {
      position: absolute; top:0; left:0; width:100%; height:100%;
      background: linear-gradient(160deg, #1a103c 0%, #000 100%);
      z-index: -2;
    }
    .orb {
      position: absolute; border-radius: 50%;
      filter: blur(80px); opacity: 0.4;
      z-index: -1;
      will-change: transform; /* GPU加速 */
      animation: float 20s infinite alternate ease-in-out;
    }
    .orb-1 { top: -10%; left: -20%; width: 80vw; height: 80vw; background: #5b2fa8; }
    .orb-2 { bottom: -10%; right: -20%; width: 90vw; height: 90vw; background: #002a6e; animation-duration: 25s; }
    @keyframes float { to { transform: translate(20px, 30px); } }

    /* --- ヘッダー --- */
    .header {
      flex-shrink: 0; /* 縮ませない */
      padding: 16px 24px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .app-logo { font-weight: 800; font-size: 16px; letter-spacing: 1px; }
    .status-badge {
      font-size: 10px; background: rgba(255,255,255,0.1); 
      padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
    }

    /* --- メインエリア（スクロール可能領域） --- */
    .main-view {
      flex: 1; /* 残りの高さを全部使う */
      position: relative;
      overflow-y: auto; /* ここだけスクロール */
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch; /* 慣性スクロール */
      padding: 20px;
      display: flex; flex-direction: column; justify-content: center; /* 設問を中央に */
    }

    /* --- 質問カード --- */
    .q-container {
      width: 100%; max-width: 500px; margin: 0 auto;
      animation: fadeUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .progress-bar {
      height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px;
      margin-bottom: 24px; overflow: hidden;
    }
    .progress-fill {
      height: 100%; background: var(--accent);
      width: 0%; transition: width 0.3s ease;
      box-shadow: 0 0 8px var(--accent);
    }
    .q-step { color: var(--accent); font-size: 12px; font-weight: 700; margin-bottom: 8px; letter-spacing: 1px; }
    .q-text { font-size: 22px; font-weight: 700; line-height: 1.5; margin-bottom: 32px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

    /* --- ボタン（タッチしやすい大きさ） --- */
    .btn-choice {
      display: block; width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border);
      padding: 18px 20px;
      margin-bottom: 12px;
      border-radius: 16px;
      color: white; font-size: 15px; font-weight: 600; text-align: left;
      transition: transform 0.1s, background 0.2s;
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      /* タップ領域を明確に */
      cursor: pointer;
    }
    .btn-choice:active {
      transform: scale(0.97);
      background: rgba(124, 77, 255, 0.2);
      border-color: var(--primary);
    }

    /* --- 結果画面 --- */
    .result-content {
      padding-bottom: 80px; /* フッター被り防止 */
      animation: zoomIn 0.4s ease;
    }
    .res-card {
      background: rgba(0,0,0,0.3); border-radius: 20px; padding: 24px;
      border: 1px solid var(--glass-border); margin-bottom: 24px;
    }
    .rec-item {
      display: flex; align-items: center; gap: 14px;
      background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid var(--glass-border);
      padding: 14px; border-radius: 16px; margin-bottom: 12px;
    }
    .rec-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #333; flex-shrink: 0; }
    .rec-btn {
      background: var(--primary); color: white; border: none;
      padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold;
      text-decoration: none; white-space: nowrap;
    }

    /* --- フッター（画面下部固定） --- */
    .footer {
      flex-shrink: 0;
      padding: 16px 24px;
      display: flex; gap: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
      background: rgba(15, 12, 41, 0.8);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    }
    .nav-btn {
      flex: 1; padding: 14px; border-radius: 12px; border: none;
      background: rgba(255,255,255,0.1); color: #ccc; font-weight: 600;
      font-size: 13px;
    }
    .nav-btn:disabled { opacity: 0.3; }
    .nav-btn:not(:disabled):active { background: rgba(255,255,255,0.2); color: white; }

    /* --- ローディング --- */
    .loader-view {
      position: absolute; top:0; left:0; width:100%; height:100%;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: #0f0c29; z-index: 50;
      transition: opacity 0.4s;
    }
    .spinner {
      width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-bottom: 16px;
    }

    @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    @keyframes zoomIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>

  <div class="bg-gradient"></div>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <div class="loader-view" id="loader">
    <div class="spinner"></div>
    <div style="font-size:11px; letter-spacing:2px; opacity:0.7;">LOADING...</div>
  </div>

  <div class="header">
    <div class="app-logo" id="ui-title">DIAGNOSIS</div>
    <div class="status-badge" id="ui-chip">BETA</div>
  </div>

  <div class="main-view" id="app-view"></div>

  <div class="footer">
    <button class="nav-btn" id="btn-back" disabled>BACK</button>
    <button class="nav-btn" id="btn-reset">RESET</button>
  </div>

  <script>
    (function(){
      // GSS URL定義
      const URLs = {
        q: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=1750400212&single=true&output=csv",
        r: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRliKpYwepLa0Z1DzzqJtDtobsdZU1uthkjiVMmIF2zTplootZrK3hpxhsyeu7GEjI5e9Zxi2UdSpye/pub?gid=0&single=true&output=csv",
        res: "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=257661142",
        set: "https://docs.google.com/spreadsheets/d/1-iNODBXpVHuF8500kBHvuJJG7XrR_pBGt-8FmClDB5o/gviz/tq?tqx=out:csv&gid=1350915999"
      };

      let db = { q:[], r:{}, res:{}, ui:{} };
      let state = { step: 0, score: {}, hist: [] };
      
      const elView = document.getElementById('app-view');
      const elLoader = document.getElementById('loader');
      const btnBack = document.getElementById('btn-back');

      // データ取得
      async function init(){
        await Promise.all([
          loadCSV(URLs.q, parseQ),
          loadCSV(URLs.r, parseRecs),
          loadCSV(URLs.res, parseRes),
          loadCSV(URLs.set, parseSet)
        ]);
        // フェードアウト
        elLoader.style.opacity = '0';
        setTimeout(()=>{ elLoader.style.display='none'; }, 400);
        render();
      }

      function render(){
        btnBack.disabled = (state.step === 0);

        // 設問モード
        if(state.step < db.q.length){
          const q = db.q[state.step];
          const pct = Math.round((state.step / db.q.length) * 100);
          
          elView.innerHTML = `
            <div class="q-container">
              <div class="progress-bar">
                <div class="progress-fill" style="width:${pct}%"></div>
              </div>
              <div class="q-step">QUESTION ${state.step+1}</div>
              <div class="q-text">${q.text}</div>
              
              <div>
                ${q.choices.map((c,i) => `
                  <button class="btn-choice" onclick="window.ans(${i})">
                    ${c.label}
                  </button>
                `).join('')}
              </div>
            </div>
          `;
          
          // 設問時は中央寄せレイアウト
          elView.style.justifyContent = 'center';
          elView.scrollTo(0,0);
        } 
        // 結果モード
        else {
          const win = Object.entries(state.score).sort((a,b)=>b[1]-a[1])[0] || ['A',0];
          const type = win[0];
          const rData = db.res[type] || {};
          const list = db.r[type] || [];

          elView.innerHTML = `
            <div class="result-content">
              <div class="res-card">
                <div style="font-size:12px;color:var(--accent);letter-spacing:1px;margin-bottom:8px;">DIAGNOSIS RESULT</div>
                <div style="font-size:24px;font-weight:800;margin-bottom:12px;line-height:1.3;">${rData.title || "結果"}</div>
                <div style="font-size:15px;line-height:1.7;opacity:0.9;white-space:pre-line;">${(rData.body||"").replace(/\\n/g, "\n")}</div>
              </div>

              <div style="font-weight:bold;margin-bottom:12px;padding-left:4px;">RECOMMEND</div>
              ${list.map(x => `
                <div class="rec-item">
                  <img class="rec-img" src="${x.img}" onerror="this.style.opacity=0">
                  <div style="flex:1;min-width:0;">
                    <div style="font-weight:700;font-size:14px;">${x.name}</div>
                    <div style="font-size:11px;opacity:0.6;">${x.text}</div>
                  </div>
                  <a href="${x.url}" class="rec-btn" target="_blank">見る</a>
                </div>
              `).join('')}
            </div>
          `;
          
          // 結果時は上詰めレイアウト
          elView.style.justifyContent = 'flex-start';
        }
      }

      window.ans = (idx) => {
        const q = db.q[state.step];
        const c = q.choices[idx];
        Object.keys(c.score).forEach(k => state.score[k] = (state.score[k]||0) + c.score[k]);
        state.hist.push(c.score);
        state.step++;
        render();
      };

      btnBack.onclick = () => {
        if(state.step>0){
          state.step--;
          const prev = state.hist.pop();
          Object.keys(prev).forEach(k => state.score[k] -= prev[k]);
          render();
        }
      };
      
      document.getElementById('btn-reset').onclick = () => {
        state.step=0; state.score={}; state.hist=[];
        render();
      };

      // CSV Parser
      async function loadCSV(u, cb){
        try{
          const r = await fetch(u + "&t=" + Date.now());
          const t = await r.text();
          cb(parse(t));
        }catch(e){}
      }
      function parse(txt){
        const rows=[]; let r=[],c="",q=false;
        for(let i=0;i<txt.length;i++){
          let ch=txt[i], n=txt[i+1];
          if(ch=='"'){ q? (n=='"'?(c+='"',i++):(q=!q)) : (q=!q); }
          else if(ch==','&&!q){ r.push(c); c=""; }
          else if((ch=='\n'||ch=='\r')&&!q){ if(ch=='\r'&&n=='\n')i++; r.push(c); rows.push(r); r=[]; c=""; }
          else c+=ch;
        }
        if(c) r.push(c); if(r.length) rows.push(r);
        const h = rows.shift().map(x=>x.trim());
        return rows.map(rw => {
          let o={}; h.forEach((k,i)=>o[k]=(rw[i]||"").trim()); return o;
        });
      }

      // Data Processors
      function parseQ(d){
        db.q = d.map(r=>{
          if(!r.qtext)return null;
          let cs=[];
          [1,2,3].forEach(n=>{
            if(r['choice'+n]) cs.push({label:r['choice'+n], score:{[(r['type'+n]||"").toUpperCase()]:Number(r['pts'+n]||0)}});
          });
          return cs.length?{text:r.qtext, choices:cs}:null;
        }).filter(Boolean);
      }
      function parseRecs(d){
        d.forEach(r=>{ let t=(r.type||"").toUpperCase(); if(!db.r[t])db.r[t]=[]; db.r[t].push(r); });
      }
      function parseRes(d){ d.forEach(r=>db.res[(r.type||"").toUpperCase()]=r); }
      function parseSet(d){
        d.forEach(r=>db.ui[r.key]=r.value);
        if(db.ui.title) document.getElementById('ui-title').innerText=db.ui.title;
        if(db.ui.chip) document.getElementById('ui-chip').innerText=db.ui.chip;
      }

      init();
    })();
  </script>
</div>
</body>
</html>
